<?php

namespace App\Http\Controllers;

use App\Models\Dokumenkegiatan;
use App\Models\Member;
use Illuminate\Support\Facades\Storage;
use Illuminate\Http\Request;

class MemberController extends Controller
{
    public function index()
    {
        $allmember = Member::all();
        return view ('sekum.member.anggota', compact('allmember'));
    }
    public function create()
    {
        return view ('sekum.member.add-anggota');
    }

    public function store(Request $request)
    {
        // data akan diproses di sini ketika disubmit (create)

        // validate data
        $validatedData = $request->validate([
            'npm'=>'required|string|max:16|unique:members,npm',
            'nama_lengkap'=>'required|string|max:100',
            'tahun_masuk'=>'required|digits:4',
            'jabatan'=>'required',
            'divisi'=>'nullable',
            'status'=>'required',
            'email'=>'required|email|max:100|unique:members,email',
            'no_hp'=>'required|string|regex:/^[0-9]{10,20}$/',
            'alamat'=>'required|string|max:255',
            'foto'=>'required|image|max:2048'
        ]);

        // simpan foto ke dalam storage
        $foto = $request->file('foto');
        $fotoname = time().'_'.$foto->getClientOriginalName();
        $foto->storeAs('Member', $fotoname, 'public');

        // simpan nama ke dalam database
        $validatedData['foto']=$fotoname;

        // simpan data
        Member::create(($validatedData));

        // redirect to index ketika berhasil disimpan
        return redirect()->route('member.index');
    }

    public function show(Member $member)
    {
        return view ('sekum.member.anggota', compact('member'));
    }

    public function edit(Member $member)
    {
        return view ('sekum.member.edit-anggota', compact('member'));
    }

    public function update(Request $request,Member $member)
    {
        // function yang memproses saat update disubmit

        // validate data
        $validatedData = $request->validate([
            'npm'=>'required|string|max:16|unique:members,npm,'. $member->id,
            'nama_lengkap'=>'required|string|max:100',
            'tahun_masuk'=>'required|digits:4',
            'jabatan'=>'required',
            'divisi'=>'required',
            'status'=>'required',
            'email'=>'required|email|max:100|unique:members,email,'. $member->id,
            'no_hp'=>'required|string|regex:/^[0-9]{10,20}$/',
            'alamat'=>'required|string|max:255',
            'foto'=>'nullable|image|mimes:jpg,jpeg,png|max:2048'
        ]);

        // cek apakah user upload foto baru
        if($request->hasFile('foto')){

            // hapus file ketika sudah ada
            if($member->foto){
                Storage::disk('public')->delete('Member/'.$member->foto);
            }

            // simpan ke file baru
            $foto = $request->file('foto');
            $fotoname = time().'_'.$foto->getClientOriginalName();
            $foto->storeAs('Member', $fotoname, 'public');

            // simpan nama ke dalam database
            $validatedData['foto']=$fotoname;
        }

        // update data
        $member->update($validatedData);

        // redirect to index ketika berhasil diupdate
        return redirect()->route('member.index');
    }

    public function destroy(Member $member)
    {
        $member->delete();
        return redirect()->route('member.index');
    }
}
